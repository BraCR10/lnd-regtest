# LND Regtest Setup

Automated script that spins up 2 Lightning Network (LND) nodes on regtest, creates wallets, funds them from bitcoind, opens a 5 BTC channel and balances it 2.5/2.5.

## Prerequisites

### 1. Bitcoin Core

Download and install from: https://bitcoincore.org/en/download/

### 2. Configure Bitcoin Core for regtest

Create or edit `~/.bitcoin/bitcoin.conf`:

```ini
server=1
daemon=1
txindex=1
regtest=1

[regtest]
fallbackfee=0.0002
rpcport=18443
port=18444
rpcbind=127.0.0.1
rpcallowip=127.0.0.1
rpcuser=YOUR_USER
rpcpassword=YOUR_PASSWORD
zmqpubrawblock=tcp://127.0.0.1:28332
zmqpubrawtx=tcp://127.0.0.1:28333
```

Start bitcoind:

```bash
bitcoind -regtest -daemon
```

Generate initial blocks (first time only):

```bash
bitcoin-cli -regtest createwallet "miner"
bitcoin-cli -regtest -rpcwallet=miner generatetoaddress 101 $(bitcoin-cli -regtest -rpcwallet=miner getnewaddress)
```

### 3. Docker

Docker and Docker Compose must be installed.

```bash
sudo apt install docker.io docker-compose-v2
sudo usermod -aG docker $USER
```

## Configuration

Edit the variables at the top of `lnd-setup.sh` to match your `bitcoin.conf`:

```bash
BITCOIND_RPC_USER="YOUR_USER"
BITCOIND_RPC_PASS="YOUR_PASSWORD"
```

## Usage

```bash
chmod +x lnd-setup.sh
./lnd-setup.sh
```

The script will prompt you for a wallet password (minimum 8 characters).

## What the script does

| Step | Description |
|------|-------------|
| 1/9 | Installs `jq` and `curl` |
| 2/9 | Cleans previous LND environment (bitcoind is **not touched**) |
| 3/9 | Asks for wallet password |
| 4/9 | Generates `lnd.conf` and `docker-compose.yml` |
| 5/9 | Starts 2 LND containers (`network_mode: host`) |
| 6/9 | Creates wallets via REST API and saves seed phrases |
| 7/9 | Enables auto-unlock and restarts containers |
| 8/9 | Funds wallets from bitcoind's `miner` wallet |
| 9/9 | Opens 5 BTC channel between lnd1 and lnd2, balances 2.5/2.5 |

## Directory structure

```
~/BTC/lnd/
├── lnd-setup.sh
├── docker-compose.yml      # generated by the script
├── lnd1/
│   ├── lnd.conf            # generated
│   └── data/
│       ├── seed.txt        # 24-word mnemonic
│       └── wallet-password.txt
└── lnd2/
    ├── lnd.conf
    └── data/
        ├── seed.txt
        └── wallet-password.txt
```

## Ports

| Service | lnd1 | lnd2 |
|---------|------|------|
| P2P | 9735 | 9736 |
| gRPC | 10009 | 10010 |
| REST | 8080 | 8081 |

## Useful commands

```bash
# lncli for each node
docker exec lnd1 lncli --network=regtest --rpcserver=127.0.0.1:10009 getinfo
docker exec lnd2 lncli --network=regtest --rpcserver=127.0.0.1:10010 getinfo

# View logs
cd ~/BTC/lnd && docker compose logs -f

# Mine blocks
bitcoin-cli -regtest -rpcwallet=miner generatetoaddress 1 $(bitcoin-cli -regtest -rpcwallet=miner getnewaddress)
```
